"use strict";var hcodeOptions=null,hcode=null,app=new Vue({el:"#app",data:{base:{version:"2.0.3",staticBase:"http://img.hcharts.cn/static/hcode/",type:0,isSaved:!1,menuOpen:!0},doctypes:["<!doctype html>",'<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">','<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">','<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">','<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">','<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">','<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">','<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">'],code:{code:null,name:null,version:null,doctype:0,description:null,group:null,newGroup:null,author:null,saveLayout:!1,autoFormat:!0,publicTemplates:[],myTemplates:[],selectedCdns:[],info:null},loginObj:{user:null,username:null,password:null,code:null,showCode:null,info:null},isMine:!1,myGroups:null,newGroup:{name:null,url:null,info:null},newLibMessage:null,newLib:null,libs:[],libSort:0,cdnDomain:"http://cdn.hcharts.cn/",cdns:null,singleCheckCdns:null},methods:{run:function(){hcode.run()},updateWithName:function(){return null===this.code.name||""===this.code.name?(this.code.info="请正确填写代码的名字！",!1):void this.update(!1,!0)},update:function(e,t){if(e||(e=!1),!this.loginObj.user)return toastr.warning("请先登录再进行操作！"),this.$refs.login.login(),!1;if(!this.code.name)return $("#fork-modal").modal(),!1;if(!this.myGroups)return toastr.warning("请创建一个默认代码分组！"),this.createGroup(),!1;var n={code:this.code.code,name:this.code.name,version:this.code.version,description:this.code.description,html:null,css:null,javascript:null,libs:[],options:null,resource:[],doctype:this.code.doctype,group:null},s=this;n.group=this.code.newGroup,this.code.saveLayout&&(n.options=hcode.getLayoutConfig());var i=_.sortBy(this.libs,function(e){return e.sort});_.each(i,function(e){e.isInner&&e.id?n.libs.push(e.id):n.resource.push(e.url)}),n.libs=n.libs.join(),n.resource=n.resource.join();for(var o in hcode.planes){var r=hcode.planes[o];r.mode&&!r.readonly&&(n[o]=r.obj.getValue())}return""===n.html&&""===n.javascript?(toastr.warning("HTML 和 JS 代码不能同时为空！"),!1):(n.isFork=e,void post("/my/save",n,function(e){return 1===e.code?(s.base.type=1,s.code.code=e.result.code,s.code.version=e.result.version,s.code.group={id:e.result.groupId,code:e.result.groupCode,name:e.result.groupName},s.code.author={id:e.result.authId,name:e.result.authName},window.history.pushState({},0,"http://"+window.location.host+"/"+s.code.group.code+"/"+s.code.code+(0===s.code.version?"":"/"+s.code.version)),$(".share-qrcode").html("<span>手机扫码预览</span>"),t&&$("#fork-modal").modal("hide"),toastr.success("代码保存成功！")):toastr.warning(e.msg),!1},!0))},login:function(){this.$refs.login.loginRequest()},needLogin:function(){return null===this.loginObj.user?(toastr.warning("请先登录再进行操作！"),this.$refs.login.login(),!0):!1},createGroup:function(){return this.needLogin()?!1:void $("#group-modal").modal()},getMyGroup:function(){var e=this;return this.myGroups&&this.myGroups.length>0?!1:void post("/my/groups",{},function(t){e.dealGroup(t.groups,!0)})},dealGroup:function(e,t){if(0===e.length)return!1;var n=null,s=this;if(t?this.myGroups=_.groupBy(e,function(e){return 1===e["default"]&&(n=e.id,e.name+=" (默认)"),e.roleStr}):_.each(e,function(e){1===e["default"]&&(e.name+=" (默认)",n=e.id),s.myGroups&&s.myGroups[e.roleStr]||(s.myGroups||(s.myGroups={}),s.myGroups[e.roleStr]=[]),s.myGroups[e.roleStr].push(e)}),t||null!==n||(n=this.code.newGroup),this.code.group)for(var i in this.myGroups){var o=_.find(this.myGroups[i],function(e){return e.id===s.code.group.id});if(o)return this.code.newGroup=this.code.group.id,!1}this.code.newGroup=n},saveGroup:function(){var e=/^[A-Za-z0-9]+[a-zA-Z\d\.\_\-]+[A-Za-z0-9]$/,t=this;if(this.newGroup.name&&this.newGroup.url){if(this.newGroup.name.length>20)return this.newGroup.info="分组名称长度不能超过20个字符",!1;if(this.newGroup.url.length<5||this.newGroup.url.length>20||!e.test(this.newGroup.url))return this.newGroup.info="个性域名不符合规范",!1;t.newGroup.info="操作中，请稍后...",post("/my/newGroup",{name:t.newGroup.name,code:t.newGroup.url},function(e){if(1===e.code){t.newGroup.info="新增分组成功";var n=[];n.push(e.groups),t.dealGroup(n,!1),setTimeout(function(){$("#group-modal").modal("hide"),t.newGroup={name:null,url:null,info:null}},1e3)}else t.newGroup.info=e.msg})}else this.newGroup.info="请填写完整信息"},fork:function(){return $("#fork-modal").modal(),!1},commonMethod:function(){this.base.staticBase=$('meta[name="staticBase"]').attr("content"),$("header").delegate(".tip-content","click",function(e){return"A"===e.target.nodeName&&2===e.target.attributes.length?!0:"INPUT"===e.target.nodeName||"LABEL"===e.target.nodeName?(e.stopPropagation(),!0):!1}),$("header").delegate(".share-tip input, .share-tip textarea","click",function(){$(this).select()}),$(".menu-title").click(function(){var e=$(this).parent();return e.hasClass("active")?!1:($("#menu .active .menu-content").slideUp(),$("#menu .active").removeClass("active"),e.addClass("active"),void e.find(".menu-content").slideDown())}),this.shortkey(),this.$refs.login.checkLogin();var e=$('textarea.code[data-type="options"]').val();e&&(e=JSON.parse(e),e.code&&(this.code=$.extend(this.code,e.code),this.base.type=void 0!==e.type?e.type:1,app.getCdns()),e.resource&&this.addInitLibs(e.resource),e.hcodeOptions&&(hcodeOptions=e.hcodeOptions),e.templates&&(this.code.publicTemplates=e.templates));var t=this;$(".menu-switch").click(function(){t.menu()})},shortkey:function(){var e=this;$(document).keydown(function(t){var n=!1;return t&&(!t.ctrlKey||13!==t.keyCode&&10!==t.keyCode?!t.ctrlKey||37!==t.keyCode&&39!==t.keyCode?t.ctrlKey&&90===t.keyCode?hcode.isFocused()||(hcode.undo(),n=!0):t.ctrlKey&&85===t.keyCode&&(hcode.isFocused()||(hcode.redo(),n=!0)):hcode.isFocused()||(e.menu(39===t.keyCode),n=!0):hcode.isFocused()||(hcode.run(),n=!0),n)?(t.preventDefault(),!1):void 0})},menu:function(e){return void 0===e&&(e=$("#menu").hasClass("toggle")),this.menuOpen===e?!1:(e?($(".menu-switch").html('<i class="fa fa-caret-square-o-left" aria-hidden="true" title="折叠菜单"></i>'),$("#menu").removeClass("toggle"),$("#editor").css("left",220)):($(".menu-switch").html('<i class="fa fa-caret-square-o-right" aria-hidden="true"></i> <span>展开菜单</span>'),$("#menu").addClass("toggle"),$("#editor").css("left",28)),hcode.refresh(),void(this.menuOpen=e))},addInitLibs:function(e){var t=e.split(",");for(var n in t)this.addLib(t[n])},addLib:function(e){var t=this;if("string"==typeof e&&(this.newLib=e),this.newLib){var n=new RegExp;if(n.compile("^[A-Za-z]+://[A-Za-z0-9-_]+\\.[A-Za-z0-9-_%&?/.=]+$"),n.test(this.newLib)){var s=_.find(this.libs,function(e){return e.url===t.newLib});if(s)return this.newLibMessage="资源 URL 已经存在",!1;var i=t.newLib.split("."),o=i[i.length-1];if("css"!==o&&"js"!==o)return this.newLibMessage="目前只支持 .js 和 .css 文件",!1;var r=t.newLib.split("/"),u=r[r.length-1],d=u;u.length>27&&(d=u.substring(0,24)+"..."),this.libs.push({showName:d,name:u,url:t.newLib,sort:t.libSort}),t.libSort++,this.newLib=null,this.newLibMessage=null}else this.newLibMessage="请输入正确的资源地址"}else this.newLibMessage="请输入正确的资源地址"},sortLib:function e(t,n){var s=t.sort,i=0,o=null,e=[];return n&&0===s||!n&&s===this.libSort-1?!1:(e=_.sortBy(this.libs,function(e){return e.sort}),i=_.findIndex(e,function(e){return e.url===t.url}),o=e[n?i-1:i+1],i=o.sort,o.sort=s,void(t.sort=i))},delLib:function(e){if(confirm("确定要删除吗？")){e.isInner&&(this.code.selectedCdns=_.filter(this.code.selectedCdns,function(t){return t!=e.id}));var t=_.sortBy(this.libs,function(e){return e.sort}),n=-1;_.each(t,function(t,s){t.id===e.id?n=s:n>=0&&s>n&&t.sort--}),this.libSort--,this.libs=_.filter(this.libs,function(t){return t.name!==e.name})}},showCdns:function(e){return e===!0?($("#cdn-modal").modal("hide"),!1):(null===this.cdns&&this.getCdns(),void $("#cdn-modal").modal())},cdnCheck:function(e,t,n){if(e.isRadio){if(this.singleCheckCdns&&this.singleCheckCdns[t]){if(this.singleCheckCdns[t]===n)return delete this.singleCheckCdns[t],!1;var s=this;this.code.selectedCdns=_.filter(this.code.selectedCdns,function(e){return e!=s.singleCheckCdns[t]}),this.code.selectedCdns.push(n+"")}this.singleCheckCdns||(this.singleCheckCdns={}),this.singleCheckCdns[t]=n}return!1},getCdns:function(e){var t=this;$.getJSON(this.base.staticBase+"scripts/cdns.json",function(e){t.cdns=e,setTimeout(function(){var n=getQueryString("theme"),s=$('#cdn-modal input[data-name="'+n+'.js"]').val();n&&s&&t.code.selectedCdns.push(s),t.code.selectedCdns.length>0&&(t.addCommonCdns(),t.singleCheckCdns={},_.each(e,function(e,n){e.isRadio&&_.each(e.files,function(e){var s=_.find(t.code.selectedCdns,function(t){return t==e.id});s&&(t.singleCheckCdns[n]=e.id)})}))},100)})},addCommonCdns:function(){var e=this,t=[],n=0,s=null;_.each(this.cdns,function(s,i){_.each(s.files,function(s){var i=_.findIndex(e.code.selectedCdns,function(e){return e==s.id});-1!==i&&t.push({id:s.id,name:s.name,showName:s.name,url:s.url,isInner:!0,sort:n++})})}),s=_.filter(this.libs,function(e){return e.isInner||(e.sort=n++),!e.isInner}),s&&s.length>0&&(t=t.concat(s)),this.libSort=n,this.libs=t,this.showCdns(!0)}}});app.commonMethod(),hcode=new HCode("#editor",hcodeOptions,function(){this.run("#loading")});